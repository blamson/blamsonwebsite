---
title: Interactive Colorado County Map
author: Brady Lamson
date: '2021-12-29'
slug: interactive-colorado-county-map
categories: []
tags: [personal, R, leaflet]
---

I'm currently working on a shiny application as a personal project alongside a fellow club officer. The app we're using uses a [data-set](https://data.colorado.gov/Higher-Education/Degrees-Awarded-to-Post-Secondary-Graduates-in-Col/hxf8-ab6k) containing information about post-secondary degrees awarded in Colorado. It contains a variety of demographic information spanning 2001 to 2017, so there's a **lot** of information here. 

My current task has been an interactive map showing where all the universities are. I've got some cool plans for it, so I would like to showcase my progress. I've been using the wonderful [Leaflet](https://leafletjs.com/) package for this and a great guide exists for those using it in [R](https://rstudio.github.io/leaflet/). 

Firstly, I knew I wanted to color the map by county so I had to figure that out. My first attempt, utilizing a lot of code from the original guide, looks as follows. 


```{r}
library(leaflet)
colorado_counties <- 
  maps::map("county", 'colorado', 
            fill = TRUE, 
            col = palette(),
            plot = FALSE
            )

map1 <- leaflet::leaflet(data = colorado_counties) |>
  addTiles() |>
  addPolygons(
    fillColor = topo.colors(64,alpha = 1), 
    stroke = FALSE
    ) |>
  widgetframe::frameableWidget()
```

```{r, echo=TRUE}
widgetframe::frameWidget(map1)
```


There are quite a number of problems with this initial build. First of all is that it's just a little unclear without any county outlines and many of the colors bleed together. There's also no limitation to zooming in and out even though there's no benefit to the end user for doing so. That's okay though! It's a very simple first step. From there I feel as if I've improved it quite a bit. I've added the following changes:

- New colors
- County outlines
- Mouseover highlighting for the map
- Max and minimum zoom
- A new tileset from the ThunderForest package. 
- markers for each of the institutions in our data frame 

```{r}
institution_locations <- readr::read_rds("institution_locations.rds")
colorado_counties <- maps::map("county", 'colorado', fill = TRUE, plot = FALSE)


map2 <- leaflet(data = colorado_counties, 
                  options = leafletOptions(
                    minZoom = 6.25,
                    maxZoom = 12.5)
                  ) |>
  addProviderTiles(providers$Thunderforest.MobileAtlas) |>
  addProviderTiles(providers$Stamen.TonerLines,
                  options = providerTileOptions(opacity = 0.35)) |>
  addProviderTiles(providers$Stamen.TonerLabels) |>
  addMarkers(~institution_locations$long, 
             ~institution_locations$lat, 
             popup = institution_locations$institutionname) |>
  leaflet::addPolygons(
    color = "#444444",
    weight = 1.5,
    smoothFactor = 1,
    fillColor = RColorBrewer::brewer.pal(12, "Paired"),
    stroke = TRUE,
    highlightOptions = highlightOptions(
      stroke = TRUE,
      color = "white",
      weight = 5,
      bringToFront = TRUE)
    )

```

```{r, echo=TRUE}
widgetframe::frameWidget(map2)
```


I still have a ton to do but as of Dec 29th thats where I'm at! I hope to update this more as I get further along. I still need to integrate this with our giant data-set so theres a lot to do. 


## Update: Jan 11

A lot of progress has been made on the map. I have gotten it working with our giant data-set and have modified a number of features. 
I have added:

- A different palette

- Updated marker icons

- Clustering for the awarded degrees, zooming in shows which batch of degrees belong to which school

Not shown here:

- Shiny re-activity has been finally added! In the web application I'm working on you can filter by the degree level, so you can look at only associates degrees for instance. That would be a huge hassle to show here though. 

- The code to setup the data. It wasn't done by me anyway and I don't want this post to be too bogged down by giant batches of code. 

```{r, echo=FALSE}
  options(readr.show_col_types = FALSE)
  data_url <- "https://data.colorado.gov/resource/hxf8-ab6k.csv?$limit=250000"
  location_df <- readRDS("institution_locations.rds")

  #print("Fetching data from url...")

  degrees_data <- data_url |>
    httr::GET() |>
    httr::content()

  #print("Found data!")

  ## Clean/Organize data
  ad_org <- degrees_data |>
    dplyr::arrange(
      year,
      institutionname
    ) |>
    dplyr::filter(
      !is.na(recordcount)
    ) |>
    dplyr::mutate(
      programname = ifelse(
        test = is.na(programname),
        yes = "General",
        no = programname
      )
    ) |>
    dplyr::left_join(location_df, by = "institutionname")

  #print("Data cleaned and ready for use!")
```

```{r}
colorado_counties <- maps::map("county", 'colorado', fill = TRUE, plot = FALSE)

map3 <- leaflet(data = colorado_counties, 
              options = leafletOptions(
                minZoom = 6,
                maxZoom = 18)
      ) |>
        addProviderTiles(providers$Thunderforest.MobileAtlas) |>
        addProviderTiles(providers$Stamen.TonerLines,
                         options = providerTileOptions(opacity = 0.35)) |>
        addProviderTiles(providers$Stamen.TonerLabels) |>
        addMarkers(ad_org$long,
                   ad_org$lat,
                   clusterOptions = markerClusterOptions(spiderfyOnMaxZoom = FALSE)
                   ) |>
        addAwesomeMarkers(lng = unique(ad_org$long),
                   lat = unique(ad_org$lat), 
                   icon = awesomeIcons(icon = 'fa-university', 
                                       markerColor = 'green', 
                                       iconColor = 'black', 
                                       library = "fa"),
                   popup = unique(ad_org$institutionname),
                   options = markerOptions(opacity = .6, 
                                           riseOnHover = TRUE)
                   ) |>
        addPolygons(
          color = "#444444",
          weight = 1.5,
          smoothFactor = 1, 
          fillColor = RColorBrewer::brewer.pal(11, "Spectral"),
          stroke = TRUE,
          highlightOptions = highlightOptions(
            stroke = TRUE,
            color = "white",
            weight = 5,
            bringToFront = TRUE)
        )
```

```{r}
widgetframe::frameWidget(map3)
```

There's still a **LOT** I want to do here. The elephant in the room is how the green markers completely overshadow the orange clusters. That would be fine, except for the fact I want the clusters to be the focus, not the markers. You can't even see the biggest cluster, the one in Denver. 

Unfortunately I've struggled to find a way to make the clusters pop out more, at least with what is built into R. Ideally I could make the circles bigger based on the number of degrees and have them in front of the markers, but I haven't been able to figure out how to accomplish that. I found options [here](https://github.com/Leaflet/Leaflet.markercluster), but I don't know how to implement these in R.

Another thing is that I'd like to make the markers color tied to the number of degrees awarded per school, though that should be easy to accomplish. Regardless, I feel like this is coming along nicely! This is a very fun package to play around with and I can see myself continuing to jump straight to this with future data sets.